# 2026-02-12 - Lightning AI Usage Fix

## Context
Ahmad reported persistent 500 errors ("failed to collect usage") when using `lightning/DeepSeek-V3.1`. The root cause was identified as the Lightning AI API failing to return the standard OpenAI `usage` block, which OpenClaw requires for accounting.

## Actions
1. **Initial Fix**: Disabled usage collection in `openclaw.json` using `compat.supportsUsageInStreaming: false`.
2. **Provider Patch**: Implemented a "Provider-level Usage Normalizer" in `@mariozechner/pi-ai` (dist/providers/openai-completions.js).
3. **Synthesis Logic**: 
   - Detects missing/zero usage after the inference loop but before returning the response to OpenClaw core.
   - Estimates token counts using a 1:4 character-to-token ratio.
   - Enforces non-zero guards (min 1 token per side, min 2 total).
   - Marks usage as `estimated: true`.
   - Explicitly calls `calculateCost()` before finalizing.

## Status
The patch is active. Ahmad confirmed the 500 error is resolved and the architecture follows his "OpenClaw-safe" requirements.
